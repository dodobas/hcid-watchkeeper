{% extends "features/features-base.html" %}
{% load pipeline %}

{% block content %}
    <div class="row">
        {#    left side #}
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Line Chart</h3>
                        </div>
                        <div class="panel-body">
                            <div id="chartWrap" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>


            <div class="row">
                <div class="col-sm-12">
                    {#        chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">Map</h3>
                        </div>
                        <div class="panel-body">
                            <div id="featureMapWrap" class='wb-map-wrap'></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Form?</h3>
                </div>
                <div class="panel-body">
                    <div id="formWrap" class='wb-form-wrap'>

                        {% include 'attributes/update_feature_form.html' %}

                    </div>
                </div>
            </div>
        </div>


        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">History Data</h3>
                </div>
                <div class="panel-body">
                     <div class="row">
        <div class="col-sm-12">
                        <div id='history-table-wrap' class='wb-form-wrap'>
                            <table id="history-table" class="display" width="100%">

                            </table>
                        </div>
        </div>
                    </div>
                </div>
            </div>
        </div>
        {#  right side end#}
    </div>



{% endblock %}

{% block extra_js %}
    <script>

        var data = JSON.parse("{{ feature_attribute_data | escapejs }}");

        var featureData = JSON.parse("{{ featureData | escapejs }}");
        var featureHistoryData = JSON.parse("{{ feature_history | escapejs }}");


        var chart = lineChart({
            data: data,
            parentId: 'chartWrap',
            svgClass: 'pie'
        });

        // Leaflet Map

        var leafletMap = showMap({
            data: featureData,
            mapId: 'featureMapWrap',
            mapConf: WB.storage.getItem('defaultMapConf')
        });

        addMarkerToMap(featureData._geometry, leafletMap, {
            data: featureData
        });

        WB.storage.setItem('featureMapWrap', leafletMap);

        // Accordion

        $("#formWrap #data-accordion").accordion({
            heightStyle: "content",
            header: "div > h3"
        });


    function updateData (formData) {
        console.log('updateData', formData);
        console.log('update url ', url_update_feature(formData._feature_uuid));
        // TODO update data
    }


        var featuresForm = new SimpleForm({
            formId: 'add_even_form',
            updateBtnSelector: '#update_button',
            updateCb: updateData,
            data: featureData,
            disabled: true
        });
        // History Table

        // Remove the add button from form - should be handled differently
        var addBtn = document.getElementById('add_button');

        addBtn.parentNode && addBtn.parentNode.removeChild(addBtn);

        WB.modal = new WB.Modal({});

        var columns = [{
            data: 'ts',
            title: 'Last update',
            searchable: false,
            orderable: true
        }, {
            data: 'email',
            title: 'User',
            searchable: false,
            orderable: true
        }];


        var options = {
            dataTable: {
                data: featureHistoryData,
                fixedHeader: true,
                columns: columns,
                "order": [[0, "desc"]],
                "lengthMenu": [[20, 50, 100, 1000, -1], [20, 50, 100, 1000, "All"]],
                rowClickCb: function (row) {
                    axPost({
                        url: '/feature-by-uuid/' +row.feature_uuid + '/' + row.changeset_id + '/',
                        method: 'GET',
                        data: null,
                        cbFunc: WB.historytable.showModalForm,
                        errCb:(e) => console.log(e)
                    })
                }
            },
            accordionOpts: {
                selector: '#wb-dialog div#data-accordion',
                opts: {
                    heightStyle: "content",
                    header: "div > h3"
                }
            }
        };

        WB.historytable = WB.tableReports.init('history-table', options);
    </script>
{% endblock %}
