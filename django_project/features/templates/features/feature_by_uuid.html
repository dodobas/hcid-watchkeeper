{% extends "features/features-base.html" %}
{% load pipeline %}

{% block content %}
    <style>
    .map-marker{
  text-align: center;
  position: absolute;
  overflow: hidden;
  background-repeat: no-repeat;
  background-position: center;
  color: #fff;
  width: 32px;
  height: 32px;
  line-height: 32PX;
  font-size: 30px;
  font-family: 'FontAwesome';
  color: blue;
}
    </style>

    <div class="row">
        {#    left side #}
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div id="chartWrap-static" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-body">
                            <div id="chartWrap-yield" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    {#        chart#}

                    <div class="panel panel-default">

                        <div class="panel-body">
                            <div id="featureMapWrap" class='wb-map-wrap'></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-heading">
                        <div class="panel-header-button">
                            <button class="btn btn-xs" id="toggle-update-form">Enable edit
                            </button>
                        </div>


                </div>
                <div class="panel-body">
                    <div id="formWrap" class='wb-form-wrap'>

                        {% include 'attributes/update_feature_form.html' %}

                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="panel panel-default">

                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div id='history-table-wrap' class='wb-form-wrap'>
                                <table id="history-table" class="display" width="100%">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {#  right side end#}
    </div>



{% endblock %}

{% block extra_js %}
    <script>

        // padding: 0 1em 0;

        var data_yield = {{ feature_attribute_data_yield | safe }};
        var data_static = {{ feature_attribute_data_static | safe }};

        var featureData = {{ featureData | safe }};
        var featureHistoryData = {{ feature_history | safe }};


        var chart_yield = lineChart({
            data: data_yield,
            parentId: 'chartWrap-yield',
            title: 'Yield',
            svgClass: 'pie',
            height: 250,
            yLabel: 'Yield'
        });

        var chart_static = lineChart({
            data: data_static,
            parentId: 'chartWrap-static',
            svgClass: 'pie',
            height: 250,
            yLabel: 'Water Level'
        });

        // Leaflet Map

        var mapConf = WB.storage.getItem('defaultMapConf');

        var leafletMap = showMap({
            data: featureData,
            mapId: 'featureMapWrap',
            mapConf: Object.assign({}, mapConf, {zoom: 12})
        });

        var dragendCB = (marker) => {
            var newPosition = marker.getLatLng();

            let featuresForm = WB.storage.getItem('featuresForm');

            featuresForm.setFormFieldValues({
                _latitude: newPosition.lat,
                _longitude: newPosition.lng,
            });
        };

        var featureMarker = addMarkerToMap({
            geometry: [featureData._geometry[1], featureData._geometry[0]],
            leafletMap,
            data: featureData,
            dragendCB
        });

        // zoom to marker
        leafletMap.fitBounds(L.latLngBounds([featureMarker.getLatLng()]), {maxZoom: 18});

        featureMarker.dragging.disable();

        WB.storage.setItem('featureMapWrap', leafletMap);

        WB.storage.setItem('featureMarker', featureMarker);
        // Accordion

        $("#formWrap #data-accordion").accordion({
            heightStyle: "content",
            header: "div > h3"
        });



        const featureUpdateSuccessCb = (result) => {

            // TODO: this is a simple way of 'refreshing' data after a successful data update
            window.location.reload(true);
        };

        // TODO refactor this
        const errCB = (request) => {
            // self.showModalForm(request.responseText)
            $('#add_even_form').remove();

            var modalDomObj = $(request.responseText);

             $('#formWrap').html(modalDomObj);

            var accordion = initAccordion({
                selector: '#formWrap div#data-accordion',
                opts: {
                    heightStyle: "content",
                    header: "div > h3"
                }
            });

            let featuresForm = WB.storage.getItem('featuresForm');

            featuresForm.init();

            // TODO handle disable later
            $(modalDomObj).find('fieldset').attr({disabled: false});
            featuresForm.setStyles(false);

        };

        var updateCb = function (formData) {
            axUpdateFeature({
                data: WB.utils.removeBlacklistedPropsFromObject({
                    flatObj: formData
                }),
                successCb: featureUpdateSuccessCb,
                errCb: errCB
            });
        };

        var featuresForm = new SimpleForm({
            formId: 'add_even_form',
            updateBtnSelector: '#update_button',
            btnHidden: true,
            updateCb: function (formData) {
                updateCb(formData);
            },

          //   data: featureData,
            is_disabled: true
        });

        WB.storage.setItem('featuresForm', featuresForm);


        // toggle-update-form
        var formToggleBtn = document.getElementById('toggle-update-form');

        WB.utils.addEvent(formToggleBtn, 'click', function (e) {

            var is_disabled = featuresForm.toggleForm();

            if (is_disabled) {
                featuresForm.setStyles(true);
                this.innerHTML = 'Enable edit';

                featureMarker.dragging.disable();
            } else {
                featuresForm.setStyles(false);
                this.innerHTML = 'Disable edit';

                featureMarker.dragging.enable();
            }
        });

        // Init Modal Class
        WB.modal = WB.modal ? WB.modal : new WB.Modal({});

        // History Table
/*
* "admin@example.com"
feature_uuid_id
:
"4768a1ae-b51c-4612-9ae6-f83887cf286a_1"
point_geometry
:
"0101000020E61000009A999999991943408195438B6CE72C40"
static_water_level
:
"3.00"
ts
:
"2017-05-31T22:00:00+00:00"
yield
:
"4.50"
* */
// moment('2017-11-06T23:00:00+00:00', 'YYYY-MM-DDTHH:mm:ssZ').format('DD-MM-YYYY HH:mm')
        var options = {
            dataTable: {
                data: featureHistoryData,
                fixedHeader: true,
                searching: false,
                columns: [{
                    data: 'ts',
                    title: 'Last update',
                    orderable: true,
                    render: function ( data, type, row, meta ) {
                        return moment(data, 'YYYY-MM-DDTHH:mm:ssZ').format('YYYY-MM-DD HH:mm');
                     }
                }, {
                    data: 'email',
                    title: 'User',
                    orderable: true
                }, {
                    data: 'static_water_level',
                    title: 'SWL',
                    orderable: true
                }, {
                    data: 'yield',
                    title: 'YLD',
                    orderable: true
                }],
                order: [[0, "desc"]],
                lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "All"]],
                rowClickCb: function (row) {

                    const key = (row.feature_uuid_id.split('_') || []);
                    axGetFeatureChangesetByUUID({
                        featureUUID: key[0],
                        changesetId: key[1],
                        successCb: function (data) {
                            WB.historytable.showModalForm(data);
                        }
                    });
                },

            },
            modalOpts: {
                modalOnOpenCb: function (data) {

                    var accordion = initAccordion({
                        selector: '#wb-dialog div#data-accordion',
                        opts: {
                            heightStyle: "content",
                            header: "div > h3"
                        }
                    });
                    var modalDomObj = data.modalObj;

                    $(modalDomObj).find('fieldset').attr({disabled: true});

                    $(modalDomObj).find('#update_button').hide();
                }
            }
        };

        // This instance has a modal attached to self (some vals are hardcoded)
        // Todo update
        WB.historytable = WB.tableReports.init('history-table', options);
    </script>
{% endblock %}
