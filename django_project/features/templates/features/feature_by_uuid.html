{% extends "features/features-base.html" %}
{% load pipeline %}

{% block content %}
    <div class="row">
        {#    left side #}
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                <i class="fa fa-line-chart" aria-hidden="true"></i> Line Chart
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="chartWrap" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>


            <div class="row">
                <div class="col-sm-12">
                    {#        chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                <i class="fa fa-map" aria-hidden="true"></i> Map
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="featureMapWrap" class='wb-map-wrap'></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title">
                         <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Form

                        <div class="panel-header-button">
                            <button class="btn btn-xs" id="toggle-update-form">Enable edit</button>
                        </div>
                    </div>

                </div>
                <div class="panel-body">
                    <div id="formWrap" class='wb-form-wrap'>

                        {% include 'attributes/update_feature_form.html' %}

                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title">
                        <i class="fa fa-history" aria-hidden="true"></i> History Data
                    </div>
                </div>
                <div class="panel-body">
                     <div class="row">
                        <div class="col-sm-12">
                            <div id='history-table-wrap' class='wb-form-wrap'>
                                <table id="history-table" class="display" width="100%">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {#  right side end#}
    </div>



{% endblock %}

{% block extra_js %}
    <script>

        var data = JSON.parse("{{ feature_attribute_data | escapejs }}");

        var featureData = JSON.parse("{{ featureData | escapejs }}");
        var featureHistoryData = JSON.parse("{{ feature_history | escapejs }}");


        var chart = lineChart({
            data: data,
            parentId: 'chartWrap',
            svgClass: 'pie'
        });

        // Leaflet Map

        var leafletMap = showMap({
            data: featureData,
            mapId: 'featureMapWrap',
            mapConf: WB.storage.getItem('defaultMapConf')
        });

        var featureMarker = addMarkerToMap(featureData._geometry, leafletMap, {
            data: featureData
        });
        featureMarker.dragging.disable();

        WB.storage.setItem('featureMapWrap', leafletMap);

        // Accordion

        $("#formWrap #data-accordion").accordion({
            heightStyle: "content",
            header: "div > h3"
        });

        // Update form callback TODO add api endpoint call
        function updateData (formData) {
            console.log('updateData', formData);
            console.log('update url ', url_update_feature(formData._feature_uuid));
            // TODO update data
        }

        var featuresForm = new SimpleForm({
            formId: 'add_even_form',
            updateBtnSelector: '#update_button',
            updateCb: updateData,
            data: featureData,
            disabled: true
        });


        // toggle-update-form
        var formToggleBtn = document.getElementById('toggle-update-form');

        WB.utils.addEvent(formToggleBtn, 'click', function (e) {
            var is_disbled = featuresForm.toggleForm();

            if (is_disbled) {
                this.innerHTML = 'Enable edit';

                featureMarker.dragging.disable();
            } else {
                this.innerHTML = 'Disable edit';

                featureMarker.dragging.enable();
            }
        });

        // Remove the add button from form - should be handled differently
        var addBtn = document.getElementById('add_button');

        addBtn.parentNode && addBtn.parentNode.removeChild(addBtn);

        // Init Modal Class
        WB.modal = WB.modal ? WB.modal : new WB.Modal({});

        // History Table

        var options = {
            dataTable: {
                data: featureHistoryData,
                fixedHeader: true,
                columns: [{
                    data: 'ts',
                    title: 'Last update',
                    searchable: false,
                    orderable: true
                }, {
                    data: 'email',
                    title: 'User',
                    searchable: false,
                    orderable: true
                }],
                order: [[0, "desc"]],
                lengthMenu: [[20, 50, 100, 1000, -1], [20, 50, 100, 1000, "All"]],
                rowClickCb: function (row) {
                    axPost({
                        url: '/feature-by-uuid/' + row.feature_uuid + '/' + row.changeset_id + '/',
                        method: 'GET',
                        data: null,
                        cbFunc: WB.historytable.showModalForm,
                        errCb:(e) => console.log(e)
                    })
                },

            },
            modalOpts: {
                modalOnOpenCb: function (data) {

                    var accordion = initAccordion({
                        selector: '#wb-dialog div#data-accordion',
                        opts: {
                            heightStyle: "content",
                            header: "div > h3"
                        }
                    });
                    var modalDomObj = data.modalObj;

                    $(modalDomObj).find('fieldset').attr({disabled: true});
                    $(modalDomObj).find('#add_button').hide();
                    $(modalDomObj).find('#update_button').hide();
                }
            }
        };

        // This instance has a modal attached to self (some vals are hardcoded)
        // Todo update
        WB.historytable = WB.tableReports.init('history-table', options);
    </script>
{% endblock %}
