{% extends "features/features-base.html" %}
{% load pipeline %}

{% block content %}
    <div class="row">
        {#    left side #}
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                <i class="fa fa-line-chart" aria-hidden="true"></i> Static Water
                                Level
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="chartWrap-static" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    {# chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                <i class="fa fa-line-chart" aria-hidden="true"></i> Yield
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="chartWrap-yield" class='wb-line-chart'></div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    {#        chart#}

                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <div class="panel-title">
                                <i class="fa fa-map" aria-hidden="true"></i> Map
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="featureMapWrap" class='wb-map-wrap'></div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title">
                        <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Form

                        <div class="panel-header-button">
                            <button class="btn btn-xs" id="toggle-update-form">Enable edit
                            </button>
                        </div>
                    </div>

                </div>
                <div class="panel-body">
                    <div id="formWrap" class='wb-form-wrap'>

                        {% include 'attributes/update_feature_form.html' %}

                    </div>
                </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <div class="panel-title">
                        <i class="fa fa-history" aria-hidden="true"></i> History Data
                    </div>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-12">
                            <div id='history-table-wrap' class='wb-form-wrap'>
                                <table id="history-table" class="display" width="100%">

                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {#  right side end#}
    </div>



{% endblock %}

{% block extra_js %}
    <script>

        var data_yield = {{ feature_attribute_data_yield | safe }};
        var data_static = {{ feature_attribute_data_static | safe }};

        var featureData = {{ featureData | safe }};
        var featureHistoryData = {{ feature_history | safe }};


        var chart_yield = lineChart({
            data: data_yield,
            parentId: 'chartWrap-yield',
            title: 'Fencing by Fencing',
            svgClass: 'pie',
            height: 250
        });

        var chart_static = lineChart({
            data: data_static,
            parentId: 'chartWrap-static',
            svgClass: 'pie',
            height: 250
        });

        // Leaflet Map

        var mapConf = WB.storage.getItem('defaultMapConf');

        var leafletMap = showMap({
            data: featureData,
            mapId: 'featureMapWrap',
            mapConf: Object.assign({}, mapConf, {zoom: 12})
        });

        var dragendCB = (marker) => {
            console.log(marker);


            var newPosition = marker.getLatLng();
            console.log('[marker dragend]', marker);
            console.log('[marker position]', newPosition);
            // update form hidden fields

            let featuresForm = WB.storage.getItem('featuresForm');

            featuresForm.setFormFieldValues({
                _latitude: newPosition.lat,
                _longitude: newPosition.lng,
            });
        };

        var featureMarker = addMarkerToMap({
            geometry: [featureData._geometry[1], featureData._geometry[0]],
            leafletMap,
            data: featureData,
            dragendCB
        });

        // zoom to marker
        leafletMap.fitBounds(L.latLngBounds([featureMarker.getLatLng()]), {maxZoom: 12});

        featureMarker.dragging.disable();

        WB.storage.setItem('featureMapWrap', leafletMap);

        // Accordion

        $("#formWrap #data-accordion").accordion({
            heightStyle: "content",
            header: "div > h3"
        });

        const featureUpdateSuccessCb = (result) => {

            // TODO: this is a simple way of 'refreshing' data after a successful data update
            window.location.reload(true);

          {% comment %}
            // update form
            const featureData = result[0];

            // const hiddenFields = ['_geometry', "_data_captor", "_created_date", "_feature_uuid"];

            // const featureData = _.omit(updatedData, hiddenFields);

            const featuresForm = WB.storage.getItem('featuresForm');

            // prepare data for field update
            const assessmentFields = Object.keys(featureData).reduce(
                (acc, cur, i) => {
                    fieldName = (cur.split('/'))[1];
                    if (fieldName) {
                        acc[fieldName] = featureData[cur];
                    }
                    return acc;
                }, {}
            );

            featuresForm.setFormFieldValues(Object.assign({}, assessmentFields, {
                _latitude: featureData._geometry[1],
                _longitude: featureData._geometry[0]
            }));
            {% endcomment %}
        };

        // TODO refactor this
        const errCB = (request) => {
            // self.showModalForm(request.responseText)
            $('#add_even_form').remove();

            var modalDomObj = $(request.responseText);
             $('#formWrap').html(modalDomObj);
            var accordion = initAccordion({
                selector: '#formWrap div#data-accordion',
                opts: {
                    heightStyle: "content",
                    header: "div > h3"
                }
            });

            $(modalDomObj).find('#add_button').hide();
            let featuresForm = WB.storage.getItem('featuresForm');
            featuresForm.init();
            // TODO handle disable later
            $(modalDomObj).find('fieldset').attr({disabled: false});


        }
        var updateCb = function (formData) {
            axUpdateFeature({
                data: WB.utils.removeBlacklistedPropsFromObject({
                    flatObj: formData
                }),
                successCb: featureUpdateSuccessCb,
                errCb: errCB
            });
        }

        var featuresForm = new SimpleForm({
            formId: 'add_even_form',
            updateBtnSelector: '#update_button',
            updateCb: function (formData) {
                updateCb(formData);
            },
          //   data: featureData,
            disabled: true
        });

        WB.storage.setItem('featuresForm', featuresForm);


        // toggle-update-form
        var formToggleBtn = document.getElementById('toggle-update-form');

        WB.utils.addEvent(formToggleBtn, 'click', function (e) {
            var is_disbled = featuresForm.toggleForm();

            if (is_disbled) {
                this.innerHTML = 'Enable edit';

                featureMarker.dragging.disable();
            } else {
                this.innerHTML = 'Disable edit';

                featureMarker.dragging.enable();
            }
        });

        // Init Modal Class
        WB.modal = WB.modal ? WB.modal : new WB.Modal({});

        // History Table

        var options = {
            dataTable: {
                data: featureHistoryData,
                fixedHeader: true,
                searching: false,
                columns: [{
                    data: 'ts',
                    title: 'Last update',
                    orderable: true
                }, {
                    data: 'email',
                    title: 'User',
                    orderable: true
                }],
                order: [[0, "desc"]],
                lengthMenu: [[20, 50, 100, -1], [20, 50, 100, "All"]],
                rowClickCb: function (row) {
                    axGetFeatureChangesetByUUID({
                        featureUUID: row.feature_uuid,
                        changesetId: row.changeset_id,
                        successCb: function (data) {
                            WB.historytable.showModalForm(data);
                        }
                    });
                },

            },
            modalOpts: {
                modalOnOpenCb: function (data) {

                    var accordion = initAccordion({
                        selector: '#wb-dialog div#data-accordion',
                        opts: {
                            heightStyle: "content",
                            header: "div > h3"
                        }
                    });
                    var modalDomObj = data.modalObj;

                    $(modalDomObj).find('fieldset').attr({disabled: true});
                    $(modalDomObj).find('#add_button').hide();
                    $(modalDomObj).find('#update_button').hide();
                }
            }
        };

        // This instance has a modal attached to self (some vals are hardcoded)
        // Todo update
        WB.historytable = WB.tableReports.init('history-table', options);
    </script>
{% endblock %}
