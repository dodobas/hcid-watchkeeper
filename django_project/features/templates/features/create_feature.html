{% extends "features/features-base.html" %}
{% load pipeline %}

{% block content %}
    <style>
        .map-marker {
            text-align: center;
            position: absolute;
            overflow: hidden;
            background-repeat: no-repeat;
            background-position: center;
            color: #fff;
            width: 32px;
            height: 32px;
            line-height: 32PX;
            font-size: 30px;
            font-family: 'FontAwesome';
            color: blue;
        }
    </style>

    <div class="row">
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="featureMapWrap" class='wb-map-wrap'></div>
                </div>
            </div>
        </div>

        <div class="col-sm-6">

            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="formWrap" class='wb-form-wrap'>

                        {% include 'attributes/create_feature_form.html' %}

                    </div>
                </div>
            </div>
        </div>

    {#  right side end#}
    </div>



{% endblock %}

{% block extra_js %}
    <script>
        var featuresForm = new SimpleForm({
            formId: 'feature-create-form',
            is_disabled: false
        });

        WB.storage.setItem('featuresForm', featuresForm);

        // TODO: is there an API to read html form data
        var form_fields = featuresForm.getFormFields();
        const featureData = {
            _geometry: [form_fields['_longitude'].value || 38.3, form_fields['_latitude'].value || 14.3]
        };

        // Leaflet Map
        var mapConf = WB.storage.getItem('defaultMapConf');

        var leafletMap = showMap({
            data: featureData,
            mapId: 'featureMapWrap',
            mapConf: Object.assign({}, mapConf, {zoom: 12})
        });

        var dragendCB = (marker) => {
            var newPosition = marker.getLatLng();

            let featuresForm = WB.storage.getItem('featuresForm');

            featuresForm.setFormFieldValues({
                _latitude: newPosition.lat,
                _longitude: newPosition.lng,
            });
        };

        var featureMarker = addMarkerToMap({
            geometry: [featureData._geometry[1], featureData._geometry[0]],
            leafletMap,
            data: featureData,
            dragendCB
        });

        // zoom to marker
        leafletMap.fitBounds(L.latLngBounds([featureMarker.getLatLng()]), {maxZoom: 12});

        featureMarker.dragging.enable();

        WB.storage.setItem('featureMapWrap', leafletMap);
        WB.storage.setItem('featureMarker', featureMarker);
        // Accordion

        $("#formWrap #data-accordion").accordion({
            heightStyle: "content",
            header: "div > h3"
        });

    </script>
{% endblock %}
