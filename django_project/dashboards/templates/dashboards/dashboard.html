{% extends "dashboards/dashboard-base.html" %}
{% load pipeline %}

{% block content %}
    <style>
        #horizontalBar .bar {
            fill: #6F257F;
        }

        #horizontalBar .axis path,
        #horizontalBar .axis line {
            fill: none;
            stroke: #D4D8DA;
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }

        #horizontalBar .x path {
            display: none;
        }
    </style>

    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="tabyiaBarChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="kushetBarChartByTabyia"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="featureMapWrap" class='wb-map-wrap'></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="fencingBarChartByTabyia"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="fencingBarChartByFencing"></div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>


        <div class="row">
            <div class="col-sm-1">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Groups</h3>
                    </div>
                    <div class="panel-body">
                        <div id="groupsCnt"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-1">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Items</h3>
                    </div>
                    <div class="panel-body">
                        <div id="itemsCnt"></div>
                    </div>
                </div>
            </div>

        </div>


    </div>



{% endblock %}

{% block extra_js %}
    <script>
        /**
         * Globals in storage WB.storage.getItem():
         * leafletMap
         * featureMarkers
         * tabyiaChart
         *
         * */
        /**
         * Tabyia Chart - bar click handler
         *
         * Fetch data for clicked tabyia and add markers to map
         * @param d
         */
        const tabyiaBarOnClickHandler = (d) => axGetTabyiaData({
            data: {
                tabiya: d.group,
                coord: getCoordFromMapBounds(WB.storage.getItem('leafletMap'))
            },
            successCb: function (data) { // TODO - add some diffing
                WB.storage.setItem('featureMarkers', createMarkersOnLayer({
                    markersData: JSON.parse(data.map_features),
                    clearLayer: true,
                    layerGroup: WB.storage.getItem('featureMarkers')
                }));
            }
        });

        const DEFAULT_CHART_HEIGHT = 400;
        /**
         * Function used from ajax CB which returns the data as string
         * Also used directly with data as Object
         * @param data
         * @param dataIsString
         */
        const initTabyiaChart = (data, dataIsString = true) => barChartHorizontal({
            data: dataIsString ? JSON.parse(data.group_cnt || '{}') : data.group_cnt,
            parentId: 'tabyiaBarChart',
            height: DEFAULT_CHART_HEIGHT * 2,
            //    svgClass: 'pie',
            valueField: 'cnt',
            labelField: 'group',
            title: 'Tabyia',
            barClickHandler: tabyiaBarOnClickHandler,
            tooltipRenderer: (d) => `<ul>
                        <li>Count: ${d.cnt}</li>
                        <li>Group: ${d.group}</li>
                        <li>Beneficiaries: ${d.beneficiaries}</li>
                        </ul>`
        });

        /**
         * Map on drag end callback
         * Fetch data for current map bounds
         * @param e
         */
        const mapOnMoveEnd = (e) => axGetTabyiaData({
            data: {coord: getCoordFromMapBounds(e)},
            successCb: function (data) {
                var fencing = JSON.parse(data.fencing_cnt);
                (WB.storage.getItem('fencingChartByFencing')).updateChart(fencing || []);
                (WB.storage.getItem('tabyiaChart')).updateChart(JSON.parse(data.group_cnt) || []);

                let dataFenc = _.map(_.groupBy(fencing, 'group'), (value, key) => {
                    return {
                        group: key,
                        cnt: _.sumBy(value, 'cnt')
                    };
                });
                (WB.storage.getItem('fencingChartByTabyia')).updateChart(dataFenc || []);
            }
        });

        // TODO all chart init and whole chart html can be rendered from one config...
        // Exported backend data

        var tabyiaData = JSON.parse("{{ group_cnt | escapejs }}");
        var fencingData = JSON.parse("{{ fencing_cnt | escapejs }}");
        var map_data = JSON.parse("{{ map_features | escapejs }}");
        var kushetData = JSON.parse("{{ kushet_cnt | escapejs }}");


        const initKuchetChartByTabyia = (data, dataIsString = true) => barChartHorizontal({
            data: dataIsString ? JSON.parse(data.kushet_cnt || '{}') : data.kushet_cnt,
            parentId: 'kushetBarChartByTabyia',
            height: DEFAULT_CHART_HEIGHT * 2,
            valueField: 'cnt',
            labelField: 'group',
            title: 'Kuchet By Tabyia',
            barClickHandler: (e) => {
                console.log(e);
            },
            tooltipRenderer: (d) => `<ul>
                    <li>Count: ${d.cnt}</li>
                    <li>Group: ${d.group}</li>
                    </ul>`
        });



        const initFencingChartByFencing = (data, dataIsString = true) => barChartHorizontal({
            data: dataIsString ? JSON.parse(data.fencing_cnt || '{}') : data.fencing_cnt,
            parentId: 'fencingBarChartByFencing',
            height: 400,
            valueField: 'cnt',
            labelField: 'fencing',
            title: 'Fencing by Fencing',
            barClickHandler: (e) => {
                console.log(e);
            },
            tooltipRenderer: (d) => `<ul>
                        <li>Count: ${d.cnt}</li>
                        <li>Fencing: ${d.fencing}</li>
                        </ul>`
        });

        const initFencingChartByTabyia = (data, dataIsString = true) => barChartHorizontal({
            data: dataIsString ? JSON.parse(data.fencing_cnt || '{}') : data.fencing_cnt,
            parentId: 'fencingBarChartByTabyia',
            height: 400,
            valueField: 'cnt',
            labelField: 'group',
            title: 'Fencing By Tabyia',
            barClickHandler: (e) => {
                console.log(e);
            },
            tooltipRenderer: (d) => `<ul>
                    <li>Count: ${d.cnt}</li>
                    <li>Group: ${d.group}</li>
                    </ul>`
        });
        // initFencingChart

        // Init Tabyia chart
        // fencingBarChartSum

        // TODO this is same as tabyia chart? Remove if it is
        const fenc = _.map(_.groupBy(fencingData, 'group'), (value, key) => {
            return {
                group: key,
                cnt: _.sumBy(value, 'cnt')
            };
        });

        var fencingBarChartByFencing = WB.storage.setItem('fencingChartByFencing', initFencingChartByFencing({fencing_cnt: fencingData}, false));
        var fencingBarChartByTabyia = WB.storage.setItem('fencingChartByTabyia', initFencingChartByTabyia({fencing_cnt: fenc}, false));
        var tabyiaBarChart = WB.storage.setItem('tabyiaChart', initTabyiaChart({group_cnt: tabyiaData}, false));
        var kushetBarChart = WB.storage.setItem('kushetChart', initKuchetChartByTabyia({kushet_cnt: kushetData}, false));

        var leafletMap = WB.storage.setItem('leafletMap', showMap({
            mapId: 'featureMapWrap',
            mapOnMoveEndHandler: mapOnMoveEnd
        }));

        // Create and Add markers to Map

        var featureMarkers = WB.storage.setItem('featureMarkers', createMarkersOnLayer({
            markersData: map_data,
            addToMap: true,
            leafletMap
        }));


        var chartData = {
            beneficiaries: {
                domId: 'beneficiariesBarChart',
                data: '',//JSON.parse("{{ beneficiaries_chart| escapejs }}"),
                groups: { // TODO will become dynamic - backend query
                    '5': {label: '5 >= 2000'},
                    '4': {label: '4 >= 1000 and < 2000'},
                    '3': {label: '3 >= 500 and < 1000'},
                    '2': {label: '2 < 500'},
                    '1': {label: '1 No Data'},
                }
            },




            fencing: {
                domId: 'fencingBarChart',
                data: '',//JSON.parse("{{ fencing_chart | escapejs }}"),
                groups: { // TODO will become dynamic - backend query
                    '5': {label: '5 >= 100'},
                    '4': {label: '4 >= 50 and < 100'},
                    '3': {label: '3 >= 10 and < 50'},
                    '2': {label: '2 < 10'},
                    '1': {label: '1 No Data'},
                }
            }
        };

    </script>
{% endblock %}
