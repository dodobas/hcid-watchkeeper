{% extends "dashboards/dashboard-base.html" %}
{% load pipeline %}

{% block content %}
    <style>
        #horizontalBar .bar {
            fill: #6F257F;
        }

        #horizontalBar .axis path,
        #horizontalBar .axis line {
            fill: none;
            stroke: #D4D8DA;
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }

        #horizontalBar .x path {
            display: none;
        }

/*Style with css*/
.map-marker{
  text-align: center;
  position: absolute;
  overflow: hidden;
  background-repeat: no-repeat;
  background-position: center;
  color: #fff;
  width: 32px;
  height: 32px;
  line-height: 32PX;
  font-size: 30px;
  font-family: 'FontAwesome';
}


.map-marker.functioning-yes {
    color: green;
}
.map-marker.functioning-no {
    color: red;
}
.map-marker.functioning-unknown {
    color: grey;
}
/* Style background*/
/*.map-marker.marker-color-gray {background: lightgray;}*/

    </style>

    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="panel-header-button">
                            <button class="btn btn-xs" id="tabiya-reset-button">Reset
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="tabiaBarChart" class="wb-chart-wrap"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="functioningPieChart" class="wb-chart-wrap"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="featureMapWrap" class='wb-map-wrap'></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="amountOfDepositedRangeChart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="fencingBarChartByFencing"></div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>

        <div class="row">
            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="waterCommiteeBarChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                     <div class="panel-body">
                        <div id="fundedByChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="staticWaterLevelChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                     <div class="panel-body">
                        <div id="yieldChart"></div>
                    </div>
                </div>
            </div>

        </div>

        <div id="table-reports-wrap" class="table-reports-wrap">
            <table id="reports-table" class="display" width="100%">
                <thead class="thead-inverse"></thead>
            </table>
        </div>
    </div>



{% endblock %}

{% block extra_js %}
    <script>

    // globals / confisg are in wb.dashboard.configs.js



    const dashboarData =  JSON.parse("{{ dashboard_chart_data | escapejs }}");

    // DATA / DATA PREPARE

    WB.storage.setItem('rangeGroups', RANGE_CHART_GROUPS);

    // update range groups in dashboard data on range charts
    updateChartDataRangeGroups(dashboarData, RANGE_CHART_GROUPS);
    renderDashboardCharts(chartDataKeys, dashboarData);

    WB.DashboardFilter = WB.storage.setItem('dashboardFilters', new DashboardFilter({
        filterKeys: ['tabiya', 'fencing_exists', 'functioning', 'funded_by', 'water_committe_exist'] // , 'static_water_level', 'amount_of_deposited', 'yield'
    }));

    // EVENTS

    // Chart Reset click event
    WB.utils.addEvent(document.getElementById('tabiya-reset-button'), 'click', function (e) {
        handleChartEvents({
            origEvent: e,
            reset: true
        });
    });

    // on resize event for all charts
    d3.select(window).on('resize', () => {
        resizeCharts(CHART_KEYS);
    });

    // LEAFLET MAP

    var leafletMap = WB.storage.setItem('leafletMap', showMap(MAP_CONFIGS));

    // Create and Add markers to Map

    var featureMarkers = WB.storage.setItem('featureMarkers', createMarkersOnLayer({
        markersData: dashboarData.mapData || [],
        addToMap: true,
        iconIdentifierKey: 'functioning',
        leafletMap
    }));


    // DATA TABLE

    var columns = [{
        data: '_last_update',
        title: 'Last Update',
        searchable: false,
        render: function ( data, type, row, meta ) {
            return moment(data, 'YYYY-MM-DDTHH:mm:ssZ').format('YYYY-MM-DD HH:mm');
         },
        orderable: true
    }, {
        data: '_webuser',
        title: 'User',
        searchable: false,
        orderable: true
    }, {
        data: 'feature_name',
        title: 'Name',
        searchable: false,
        orderable: true
    }, {
        data: 'tabiya',
        title: 'Tabiya',
        searchable: false,
        orderable: true
    }, {
        data: 'yield',
        title: 'YLD',
        searchable: false,
        orderable: true
    }, {
        data: 'static_water_level',
        title: 'SWL',
        searchable: false,
        orderable: true
    }];

    var options = {
        dataTable: {
            data: dashboarData.tableData,
            searching: false,
            scrollX: true,
            fixedHeader: true,
            columns: columns,
            order: [],
            lengthMenu: [[10, 20, 50, 100, 1000, -1], [10, 20, 50, 100, 1000, "All"]],
            rowClickCb: function (row) {
                var uuid = row.feature_uuid;

                if (!uuid) {
                    throw new Error(`Row UUID not valid - ${uuid}`);
                }
                openInNewTab('/feature-by-uuid/' + uuid);
            }

        }
    };

   WB.storage.setItem('dashboardTable', WB.tableReports.init('reports-table', options));
    </script>
{% endblock %}
