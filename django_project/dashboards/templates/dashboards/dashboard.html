{% extends "dashboards/dashboard-base.html" %}
{% load pipeline %}

{% block content %}

    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="panel-header-button">
                            <button class="btn btn-xs" id="tabiya-reset-button">Reset
                            </button>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div id="tabiaBarChart" class="wb-chart-wrap"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="row">
                    <div class="col-sm-12">

                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="functioningPieChart" class="wb-chart-wrap"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12">
                        <div class="panel panel-default">
                             <div class="panel-body">
                                <div id="fundedByChart"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>


            <div class="col-sm-6">

                <div class="row">
                    <div class="col-sm-12">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="featureMapWrap" class='wb-map-wrap'></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="waterCommiteeBarChart"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-12 col-md-6">
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div id="fencingBarChartByFencing"></div>
                            </div>
                        </div>
                    </div>

                </div>


            </div>
        </div>

        <div class="row">
            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="amountOfDepositedRangeChart"></div>
                    </div>
                </div>
            </div>


            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <div id="staticWaterLevelChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-6 col-md-3">
                <div class="panel panel-default">
                     <div class="panel-body">
                        <div id="yieldChart"></div>
                    </div>
                </div>
            </div>

        </div>

        <div id="table-reports-wrap" class="table-reports-wrap">
            <table id="reports-table" class="display" width="100%">
                <thead class="thead-inverse"></thead>
            </table>
        </div>
    </div>



{% endblock %}

{% block extra_js %}
    <script>
    // TODO REFACTOR / UNIFY / NAMESPACE GUIDELINE
    // general flow:

    // on init initial data is exported to the page context
    // range chart data needs to be updated with range groups labels
    // render all charts from chart config
    // render map with markers
    // render table
    // init dashboard filters
    // charts are used as multiselect filters
    // filter is set on bar / pie slice click
    // filter is removed on already clicked bar / pie slice
    // clicked chart will freeze and will not be updated with new data
    // reset all button will reset all filters and fetch new data
    // map on dragend will fetch new data and update all charts (selected chart filters will stay selected)


    // globals / confisg are in wb.dashboard.configs.js

    const dashboarData =  JSON.parse("{{ dashboard_chart_data | escapejs }}");


    // DATA TABLE

    var DASHBOARD_PAGE_TABLE_COLUMNS = [{
        data: '_last_update',
        title: 'Last Update',
        searchable: false,
        render: timestampColumnRenderer,
        orderable: true
    }, {
        data: '_webuser',
        title: 'User',
        searchable: false,
        orderable: true
    }, {
        data: 'feature_name',
        title: 'Name',
        searchable: false,
        orderable: true
    }, {
        data: 'tabiya',
        title: 'Tabiya',
        searchable: false,
        orderable: true
    }, {
        data: 'yield',
        title: 'YLD',
        searchable: false,
        orderable: true
    }, {
        data: 'static_water_level',
        title: 'SWL',
        searchable: false,
        orderable: true
    }];

    var options = {
        dataTable: {
            data: dashboarData.tableData,
            searching: false,
            scrollX: true,
            fixedHeader: true,
            columns: DASHBOARD_PAGE_TABLE_COLUMNS,
            order: [],
            lengthMenu: TABLE_ROWS_PER_PAGE,
            rowClickCb: tableRowClickHandlerFn

        }
    };


    // DATA / DATA PREPARE
    WB.controller = new DashboardController({
        chartConfigs: CHART_CONFIGS,
        dashboarData: dashboarData,
        tableConfig: options,
        mapConfig: MAP_CONFIGS
    });

    // EVENTS


    </script>
{% endblock %}
