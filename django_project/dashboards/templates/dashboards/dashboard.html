{% extends "dashboards/dashboard-base.html" %}
{% load pipeline %}

{% block content %}
<style>
#horizontalBar  .bar {
	fill: #6F257F;
}
#horizontalBar .axis path,
#horizontalBar .axis line {
  fill: none;
  stroke: #D4D8DA;
  stroke-width: 1px;
  shape-rendering: crispEdges;
}
#horizontalBar  .x path {
	display: none;
}
</style>

    <div class="container-fluid">

    <div class="row">
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Map</h3>
                </div>
                <div class="panel-body">
                    <div id="featureMapWrap" class='wb-map-wrap'></div>
               </div>
            </div>
        </div>

        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Horiz bar</h3>
                </div>
                <div class="panel-body">
                    <div id="horizontalBar"></div>
               </div>
            </div>
        </div>

    </div>


    <div class="row">
        <div class="col-sm-1">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Groups</h3>
                </div>
                <div class="panel-body">
                    <div id="groupsCnt"></div>
               </div>
            </div>
        </div>

        <div class="col-sm-1">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Items</h3>
                </div>
                <div class="panel-body">
                    <div id="itemsCnt"></div>
               </div>
            </div>
        </div>

    </div>



    <div class="row">
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Groups</h3>
                </div>
                <div class="panel-body">
                    <div id="groupChartWrap"></div>
               </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Fencing</h3>
                </div>
                <div class="panel-body">
                    <div id="fencingChartWrap"></div>
               </div>
            </div>
        </div>

    </div>


      <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Fencing Bar</h3>
                </div>
                <div class="panel-body">
                    <div id="fencingBarChartWrap"></div>
               </div>
            </div>
        </div>


          <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Small Fencing Bar</h3>
                </div>
                <div class="panel-body">
                    <div id="smallFencingBarChartWrap"></div>
               </div>
            </div>
        </div>

    </div>




      <div class="row">
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Functional</h3>
                </div>
                <div class="panel-body">
                    <div id="functioningChartWrap"></div>
               </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Scheme Type</h3>
                </div>
                <div class="panel-body">
                    <div id="schemetypeChartWrap"></div>
               </div>
            </div>
        </div>

    </div>
        {#        # groupChartWrap, fencingChartWrap, yieldChartWrap, functioningChartWrap, schemetypeChartWrap#}

<div class="row">
        <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Functioning Bar</h3>
                </div>
                <div class="panel-body">
                    <div id="functioningBarChartWrap"></div>
               </div>
            </div>
        </div>


          <div class="col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Small Functioning Bar</h3>
                </div>
                <div class="panel-body">
                    <div id="smallFunctioningBarChartWrap"></div>
               </div>
            </div>
        </div>

    </div>

    <div class="row">
{#    left side #}
    <div class="col-sm-6">
        <div class="row">
            <div class="col-sm-12">
                {# chart#}

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Yield</h3>
                    </div>
                    <div class="panel-body">
                        <div id="yieldChartWrap" class='wb-pie-chart'></div>
                    </div>
                </div>

            </div>
        </div>


        <div class="row">
            <div class="col-sm-12">
            </div>
        </div>
    </div>
{#  left side end#}
{#  right side#}
    <div class="col-sm-6">

        <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Map</h3>
                    </div>
                    <div class="panel-body">
                        <div id="featureMapWrap" class='wb-map-wrap'></div>
                    </div>
                </div>
    </div>
{#  right side end#}
</div>


    </div>



{% endblock %}

{% block extra_js %}
    <script>
        var data = JSON.parse("{{ group_cnt | escapejs }}");

         var leafletMap = showMap({
            data: [], //featureData,
            mapId: 'featureMapWrap',
            mapConf: WB.storage.getItem('defaultMapConf')
        });

{#        addMarkerToMap(featureData._geometry, leafletMap, {#}
{#            data: featureData#}
{#        });#}
        var chartData = {
            fencing: {
                data: JSON.parse("{{ fencing_chart | escapejs }}"),
                groups: { // TODO will become dynamic - backend query
                    '5': {label: '5 >= 100'},
                    '4': {label: '4 >= 50 and < 100'},
                    '3': {label: '3 >= 10 and < 50'},
                    '2': {label: '2 < 10'},
                    '1': {label: '1 No Data'},
                }
            }
        };

        // filters
        var fencingData = chartData.fencing.data.map(
            (i) => Object.assign({}, i, {group: chartData.fencing.groups[i.filter_group].label})
        );

        var fencingColumns = _.map(chartData.fencing.groups, i => i.label);

        var fencingBarChart = barChartHorizontal({
            data: fencingData,
            columns: fencingColumns,
            parentId: 'horizontalBar',
            svgClass: 'pie'
        });

{#        console.log('chart_data', chart_data);#}

        var fencing_cnt = JSON.parse("{{ fencing_cnt | escapejs }}");
        var schemetype_cnt = JSON.parse("{{ schemetype_cnt | escapejs }}");
        var functioning_cnt = JSON.parse("{{ functioning_cnt | escapejs }}");
        var yield_cnt = JSON.parse("{{ yield_cnt | escapejs }}");

        var itemsCnt = document.getElementById('itemsCnt');
        var groupsCnt = document.getElementById('groupsCnt');

// 5 >= 100
// 4 >= 50 and < 100
// 3 >= 10 and < 50
// 2 < 10
// 1 No Data

        itemsCnt.innerHTML = 0;
        groupsCnt.innerHTML = 0;

        if ((data || []) && data.length > 0) {
            itemsCnt.innerHTML = _.sumBy(data, 'cnt');
            groupsCnt.innerHTML = data.length;

            var chart = donutChart({
                data: data,
                parentId: 'groupChartWrap',
                svgClass: 'pie'
            });
        }


        // FENCING CHARTS

        var fencing_groups = _.groupBy(fencing_cnt, 'group');
        var fencing_groups_sum = [];
        _.forEach(fencing_groups, (i, key) => {
           fencing_groups_sum[fencing_groups_sum.length] = {
               group: key,
               cnt: _.sumBy(i, 'cnt')
           };
        });
        var fencingChart = donutChart({
            data: fencing_groups_sum,
            parentId: 'fencingChartWrap',
            svgClass: 'pie'
        });
        var fencingBarChart = barChart({
            data: fencing_groups_sum,
            parentId: 'fencingBarChartWrap',
            svgClass: 'pie',
            smallData: fencing_groups,
            innerId: 'smallFencingBarChartWrap',
            innerCB: function (i) {
                return {
                    group: i.fencing || 'Unknown',
                    cnt: i.cnt
                }
            }
        });

        /*

>= 1000
>= 500 and < 1000
>= 100 and < 500
< 100
No Data


>= 100
>= 50 and < 100
>= 10 and < 50
< 10
No Data



         */



        // SCHEME CHARTS
        var schemetypeChart = donutChart({
            data: schemetype_cnt,
            parentId: 'schemetypeChartWrap',
            svgClass: 'pie'
        });


        // YIELD CHARTS
        var yieldChart = donutChart({
            data: yield_cnt,
            parentId: 'yieldChartWrap',
            svgClass: 'pie'
        });


        // FUNCTIONING CHARTS


        var functioning_groups = _.groupBy(functioning_cnt, 'group');
        var functioning_groups_sum = [];
        _.forEach(functioning_groups, (i, key) => {
           functioning_groups_sum[functioning_groups_sum.length] = {
               group: key,
               cnt: _.sumBy(i, 'cnt')
           };
        });

        var functioningChart = barChart({
            data: functioning_groups_sum,
            parentId: 'functioningBarChartWrap',
            svgClass: 'pie',
            smallData: functioning_groups,
            innerId: 'smallFunctioningBarChartWrap',
            innerCB: function (i) {
                return {
                    group: i.functioning || 'Unknown',
                    cnt: i.cnt
                }
            }
        });


        var functioningChart = donutChart({
            data: functioning_groups_sum,
            parentId: 'functioningChartWrap',
            svgClass: 'pie'
        });

    </script>
{% endblock %}
