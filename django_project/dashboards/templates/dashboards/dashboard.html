{% extends "dashboards/dashboard-base.html" %}
{% load pipeline %}

{% block content %}
    <style>
        #horizontalBar .bar {
            fill: #6F257F;
        }

        #horizontalBar .axis path,
        #horizontalBar .axis line {
            fill: none;
            stroke: #D4D8DA;
            stroke-width: 1px;
            shape-rendering: crispEdges;
        }

        #horizontalBar .x path {
            display: none;
        }
    </style>

    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Map</h3>
                    </div>
                    <div class="panel-body">
                        <div id="featureMapWrap" class='wb-map-wrap'></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Fencing</h3>
                    </div>
                    <div class="panel-body">
                        <div id="fencingBarChart"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Beneficiaries</h3>
                    </div>
                    <div class="panel-body">
                        <div id="beneficiariesBarChart"></div>
                    </div>
                </div>
            </div>

        </div>


        <div class="row">
            <div class="col-sm-1">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Groups</h3>
                    </div>
                    <div class="panel-body">
                        <div id="groupsCnt"></div>
                    </div>
                </div>
            </div>

            <div class="col-sm-1">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Items</h3>
                    </div>
                    <div class="panel-body">
                        <div id="itemsCnt"></div>
                    </div>
                </div>
            </div>

        </div>


        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Groups</h3>
                    </div>
                    <div class="panel-body">
                        <div id="groupChartWrap"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Fencing</h3>
                    </div>
                    <div class="panel-body">
                        <div id="fencingChartWrap"></div>
                    </div>
                </div>
            </div>

        </div>


        <div class="row">
            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Fencing Bar</h3>
                    </div>
                    <div class="panel-body">
                        <div id="fencingBarChartWrap"></div>
                    </div>
                </div>
            </div>


            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Small Fencing Bar</h3>
                    </div>
                    <div class="panel-body">
                        <div id="smallFencingBarChartWrap"></div>
                    </div>
                </div>
            </div>

        </div>


        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Functional</h3>
                    </div>
                    <div class="panel-body">
                        <div id="functioningChartWrap"></div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Scheme Type</h3>
                    </div>
                    <div class="panel-body">
                        <div id="schemetypeChartWrap"></div>
                    </div>
                </div>
            </div>

        </div>
        {#        # groupChartWrap, fencingChartWrap, yieldChartWrap, functioningChartWrap, schemetypeChartWrap#}

        <div class="row">
            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Functioning Bar</h3>
                    </div>
                    <div class="panel-body">
                        <div id="functioningBarChartWrap"></div>
                    </div>
                </div>
            </div>


            <div class="col-sm-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Small Functioning Bar</h3>
                    </div>
                    <div class="panel-body">
                        <div id="smallFunctioningBarChartWrap"></div>
                    </div>
                </div>
            </div>

        </div>

        <div class="row">
            {#    left side #}
            <div class="col-sm-6">
                <div class="row">
                    <div class="col-sm-12">
                        {# chart#}

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Yield</h3>
                            </div>
                            <div class="panel-body">
                                <div id="yieldChartWrap" class='wb-pie-chart'></div>
                            </div>
                        </div>

                    </div>
                </div>


                <div class="row">
                    <div class="col-sm-12">
                    </div>
                </div>
            </div>
            {#  left side end#}
            {#  right side#}
            <div class="col-sm-6">

                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Map</h3>
                    </div>
                    <div class="panel-body">
                        <div id="featureMapWrap" class='wb-map-wrap'></div>
                    </div>
                </div>
            </div>
            {#  right side end#}
        </div>


    </div>



{% endblock %}

{% block extra_js %}
    <script>
        function mapOnMoveEnd(e) {

            const bounds = e.getBounds();
            var coord = [bounds.getWest(), bounds.getNorth(), bounds.getEast(), bounds.getSouth()];

            // TODO add from conf
            $.ajax({
                type: 'GET',
                url: '/data/',
                data: {coord: coord},
                success: function (data) {
                    console.log(data);

                    var tabya = JSON.parse(data.group_cnt || '{}');

                    console.log(tabya);

                    var beneficiariesBarChart = barChartHorizontal({
                        data: tabya,
                        // columns: columns,
                        parentId: 'beneficiariesBarChart',
                        height: 340,
                        svgClass: 'pie',
                        valueField: 'cnt',
                        labelField: 'group',
                        barClickHandler: function (d) {
                            console.log(d);
                            console.log(this);
                            console.log('[clicked bar]', d);

                            $.ajax({
                                type: 'GET',
                                url: '/data/',
                                data: {tabiya: d.group, coord},
                                success: function (data) {
                                    var mapData = JSON.parse(data.map_features);
                                    console.log(data);
                                    //map_features

                                    var layer = WB.storage.getItem('featureMarkers');

                                    layer.clearLayers();


                                    for (i = 0; i < dataCnt; i += 1) {
                                        var marker = mapData[i];

                                        L.marker(L.latLng(marker.lat, marker.lng), {
                                            // icon: new L.WbDivIcon(),
                                            draggable: false
                                        }).bindPopup(marker.feature_uuid).addTo(layer);
                                    }
                                    //   featureMarkers.addTo(leafletMap);
                                }
                            })
                        }
                    });
                    // console.log('chart_data', chart_data);
                },
                error: function (err) {
                    throw new Error(err);
                },

            })


        }


        var data = JSON.parse("{{ group_cnt | escapejs }}");
        var map_data = JSON.parse(" {{ map_features | escapejs }}");

        // MAP


        var leafletMap = WB.storage.setItem('leafletMap', showMap({
            data: [], //featureData,
           // initialMapView: data._geometry
            mapId: 'featureMapWrap',
            mapOnMoveEndHandler: mapOnMoveEnd
        }));

         var featureMarkers = createMarkersOnLayer({
            markersData: map_data,
            addToMap: true,
            leafletMap
        });

        WB.storage.setItem('featureMarkers', featureMarkers);


        var chartData = {
            beneficiaries: {
                domId: 'beneficiariesBarChart',
                data: JSON.parse("{{ beneficiaries_chart| escapejs }}"),
                groups: { // TODO will become dynamic - backend query
                    '5': {label: '5 >= 2000'},
                    '4': {label: '4 >= 1000 and < 2000'},
                    '3': {label: '3 >= 500 and < 1000'},
                    '2': {label: '2 < 500'},
                    '1': {label: '1 No Data'},
                }
            },
            fencing: {
                domId: 'fencingBarChart',
                data: JSON.parse("{{ fencing_chart | escapejs }}"),
                groups: { // TODO will become dynamic - backend query
                    '5': {label: '5 >= 100'},
                    '4': {label: '4 >= 50 and < 100'},
                    '3': {label: '3 >= 10 and < 50'},
                    '2': {label: '2 < 10'},
                    '1': {label: '1 No Data'},
                }
            }
        };

        // HORIZONTAL fENCING

        // add label to chart data
        var fencingData = chartData.fencing.data.map(
            (i) => Object.assign({}, i, {group: chartData.fencing.groups[i.filter_group].label})
        );

        var fencingColumns = _.map(chartData.fencing.groups, i => i.label);

        {#        var fencingBarChart = barChartHorizontal({#}
        {#            data: fencingData,#}
        {#            columns: fencingColumns,#}
        {#            parentId: 'fencingBarChart',#}
        {#            height: 340,#}
        {#            svgClass: 'pie'#}
        {#        });#}

        // beneficiariesBarChart


        // Tabyia

        var beneficiariesBarChart = barChartHorizontal({
            data: data,
            parentId: 'beneficiariesBarChart',
            height: 340,
            svgClass: 'pie',
            valueField: 'cnt',
            labelField: '',
            minValueField: 'cnt_min',
            maxValueField: 'cnt_max'
        });


    </script>
{% endblock %}
