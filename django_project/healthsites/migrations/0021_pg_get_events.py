# -*- coding: utf-8 -*-
# Generated by Django 1.11.8 on 2017-12-20 22:44
from __future__ import unicode_literals

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ('healthsites', '0020_auto_20160627_1038'),
    ]

    operations = [
        migrations.RunSQL('create schema if not exists core_utils;'),

        migrations.RunSQL("""

CREATE OR REPLACE FUNCTION core_utils.get_events(
    p_min_x double precision,
    p_min_y double precision,
    p_max_x double precision,
    p_max_y double precision)
  RETURNS text AS
$BODY$
SELECT
    coalesce(json_agg(d.row)::TEXT, '[]') AS data
from
(
	select
		json_build_object(
			   'assessment', json_object_agg(
			       ag_name || '/' || ac_name,
			       json_build_object(
				   'option', '',
				   'value', r.value,
				   'description', ''
			       )
			   ),
			   'id', r.id,
			   'created_date', r.created_date,
			   'data_captor', r.email,
			   'overall_assessment', r.overall_assessment,
			   'name', r.name,
			   'geometry', r.geometry,
			   'enriched', r.enriched,
			   'country', r.country
		       ) AS row
	from 
	(
		SELECT
			ag.name as ag_name,
			ac.name as ac_name,
			case
				when ac.result_type = 'Integer' then val_int::varchar
				when ac.result_type = 'Decimal' then val_real::varchar
				when ac.result_type = 'DropDown' then val_text::varchar
				when ac.result_type = 'MultipleChoice' then val_text::varchar

				else null
			end as value,
			hs.id,
			hs.created_date,
			wu.email,
			hs.overall_assessment,
			hs.name,
			ARRAY [ST_X(hs.point_geometry), ST_Y(hs.point_geometry)] as geometry,
			true as enriched,
			'Unknown'::text as country
		       
		FROM
		    feature_attribute_value fav
		    INNER JOIN healthsites_healthsiteassessment hs
			ON fav.healthsite_assessment_id = hs.id AND
			   hs.point_geometry && ST_SetSRID(ST_MakeBox2D(ST_Point($1, $2), ST_Point($3, $4)),4326)
		    INNER JOIN webusers_webuser wu ON hs.data_captor_id = wu.id
		    INNER JOIN healthsites_assessmentcriteria ac ON ac.id = fav.assessment_criteria_id
		    INNER JOIN healthsites_assessmentgroup ag ON ag.id = ac.assessment_group_id
	order by id
	) r

	group by
		r.id
		,r.created_date
		,r.email
		, r.overall_assessment
		, r.name
		, r.geometry
		, r.enriched
		, r.country
) d;
$BODY$
  LANGUAGE sql STABLE
;
            """),
    ]
