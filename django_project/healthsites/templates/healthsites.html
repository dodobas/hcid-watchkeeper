{% extends "healthsites/base.html" %}
{% load pipeline %}
{% block extra_js %}
    <script type="text/javascript" src="/static/js/healthsites_view.js"></script>
    {% javascript 'feature' %}
{% endblock %}
{% block header %}

    <script>
        $(document).ready(function () {

            let leafletMap = show_map();

            var mapLayers = WB.storage.setItem('mapLayers', {
                "healthsitesGroup": L.layerGroup([]).addTo(leafletMap),
                "assessmentsGroup": L.layerGroup([]).addTo(leafletMap),
                "enrichedGroup": L.layerGroup([]).addTo(leafletMap)
            });

            leafletMap.addLayer(new L.FeatureGroup());

            L.control.layers({}, {
                "Healthsites": mapLayers['healthsitesGroup'],
                "Assessments": mapLayers['assessmentsGroup'],
                "Enriched Healthsites": mapLayers['enrichedGroup']
            }).addTo(leafletMap);

            leafletMap.on('moveend', function (e) {
                get_healthsites_markers(leafletMap);
                get_event_markers(leafletMap);
            });
            leafletMap.on('click', function (e) {
                //map_clicked();
            });
            leafletMap.on('overlayadd', function (e) {
                toggleLayers(leafletMap, e.name, true);
            });

            leafletMap.on('overlayremove', function (e) {
                toggleLayers(leafletMap, e.name, false);
            });
            {# ----------------------------------------------------- #}

             get_healthsites_markers(leafletMap);
            get_event_markers(leafletMap);

            $('#nav_healthsite').addClass("active");
            $('#id_date_time').datetimepicker({
                format: 'yyyy-mm-dd hh:ii',
                todayBtn: true,
                todayHighlight: true,
                autoclose: true,
                minuteStep: 1
            });

            $("#data-accordion").accordion({
                heightStyle: "content"
            });
            $('#id_latitude').prop('disabled', true);
            $('#id_longitude').prop('disabled', true);
            $('#id_assessment_id').prop('disabled', true);
            $('#id_healthsite_id').prop('disabled', true);

            $('#id_latest_data_captor').prop('disabled', true);
            $('#id_latest_update').prop('disabled', true);

            $('#div_id_assessment_id').hide();
            $('#div_id_healthsite_id').hide();

        });
        // TODO conflicts with fncs in browser page
        function show_detail(marker) {
            var data = marker.data;
            $('.alert').remove();
            // change button state
            $("#update_button").hide();
            $("#add_button").show();


            // TODO change this
            var logged_user = "{{ user.email }}";

            if (logged_user === data.data_captor) {
                $("#update_button").show();
            }
            autofill_form(data);
            set_long_lat_form(data['latlng']);
         //   remove_new_marker();
           // add_new_event_marker(data['latlng']['lat'], data['latlng']['lng'], marker.options.icon);
            if (!$('#side_panel').is(":visible")) {
                toggle_side_panel();
            }

            var map = WB.storage.getItem('map');

            map.removeLayer(
                WB.storage.getItem('selectedMarker')
            );
        }

        function show_dashboard() {
            $('.alert').remove();
            var eventMarker = WB.storage.getItem('eventMarker');
            if (!eventMarker) {
                reset_form();
                $("#add_button").hide();
                $("#update_button").hide();
            }
        }
    </script>
{% endblock header %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            {# side panel #}
            <div class="col-lg-5" id="side_panel">
                <div class="bs-component">
                    <div class="panel panel-primary">
                        <div id="messages_wrapper"></div>
                        <div class="panel-heading panel-heading-without-padding">
                            <h4>
                                <a id="hide_toogle"
                                   href="javascript:void(0)"
                                   class="btn btn-fab btn-raised glyphicon glyphicon-chevron-left toogle-button"
                                   onclick="toggle_side_panel()"></a>
                                <i class="mdi-content-add-box"></i>
                                Add Water Feature Assessment
                            </h4>
                        </div>
                        <div class="panel-body">
                            {% include "add_assessment_form.html" %}
                        </div>
                    </div>
                </div>
            </div>
            {# end side panel #}
            {# map #}
            <div class="col-lg-7" style="margin:0; padding:0;">
                <div class="row">
                    <div class="col-lg-7 affix" id="map" class="wb-map-wrap"></div>
                </div>
            </div>
            {# end side panel #}
        </div>
        {# show hide toggle #}
        <a id="show_toogle"
           style="display:none;"
           href="javascript:void(0)"
           class="btn btn-fab btn-raised glyphicon glyphicon-chevron-right toogle-button"
           onclick="toggle_side_panel()"></a>

    </div>
{% endblock content %}
