{% extends "event_mapper/base.html" %}
{% block extra_js %}
    <script type="text/javascript" src="/static/js/healthsites_view.js"></script>
{% endblock %}
{% block header %}

    <script>
        $(document).ready(function () {
            //< script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false">< / script>
            {# ----------------------------------------------------- #}
            {# control of authentication #}
           {
                var context = {
                    'bounds': [
                        [{{ user.south }}, {{ user.west }}],
                        [{{ user.north }}, {{ user.east }}]]
                };
                show_map(context);
            }

            // Initialise the FeatureGroup to store editable layers
            // WB.globals.drawnItems = new L.FeatureGroup();
            WB.globals.map.addLayer(new L.FeatureGroup());



            if (!healthsites_group) {
                healthsites_group = L.layerGroup([]);
                healthsites_group.addTo(WB.globals.map);
            }
            if (!assessments_group) {
                assessments_group = L.layerGroup([]);
                assessments_group.addTo(WB.globals.map);
            }
            if (!enriched_group) {
                enriched_group = L.layerGroup([]);
                enriched_group.addTo(WB.globals.map);
            }
            var overlayMaps = {
                "Healthsites": healthsites_group,
                "Assessments": assessments_group,
                "Enriched Healthsites": enriched_group
            };
            L.control.layers({}, overlayMaps).addTo(WB.globals.map);

            {# ----------------------------------------------------- #}
            set_offset();
             get_healthsites_markers();
            get_event_markers();
            $('#nav_healthsite').addClass("active");
            $('#id_date_time').datetimepicker({
                format: 'yyyy-mm-dd hh:ii',
                todayBtn: true,
                todayHighlight: true,
                autoclose: true,
                minuteStep: 1
            });

            $("#data-accordion").accordion({
                heightStyle: "content"
            });
            $('#id_latitude').prop('disabled', true);
            $('#id_longitude').prop('disabled', true);
            $('#id_assessment_id').prop('disabled', true);
            $('#id_healthsite_id').prop('disabled', true);

            $('#id_latest_data_captor').prop('disabled', true);
            $('#id_latest_update').prop('disabled', true);

            $('#div_id_assessment_id').hide();
            $('#div_id_healthsite_id').hide();

           WB.globals.map.on('moveend', function (e) {
                get_healthsites_markers();
                get_event_markers();
            });
            WB.globals.map.on('click', function (e) {

            });
        });
        function show_detail(marker) {
            var data = marker.data;
            $('.alert').remove();
            // change button state
            $("#update_button").hide();
            $("#add_button").show();
            {# update #}
            var logged_user = "{{ user.email }}";
            if (logged_user == data.data_captor) {
                $("#update_button").show();
            }
            autofill_form(data);
            set_long_lat_form(data['latlng']);
         //   remove_new_marker();
           // add_new_event_marker(data['latlng']['lat'], data['latlng']['lng'], marker.options.icon);
            if (!$('#side_panel').is(":visible")) {
                toggle_side_panel();
            }
            WB.globals.map.removeLayer(selected_marker);
        }

        function show_dashboard() {
            $('.alert').remove();
            if (!WB.globals.eventMarker) {
                reset_form();
                $("#add_button").hide();
                $("#update_button").hide();
            }
        }





var wbMap = function (leaflet) {

    var startPoint = [43.1249, 1.254];
    var map = L.map('map2', {editable: true}).setView(startPoint, 16);

    var tilelayer = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      maxZoom: 20,
      attribution: 'Data \u00a9 <a href="http://www.openstreetmap.org/copyright"> OpenStreetMap Contributors </a> Tiles \u00a9 HOT'}).addTo(map);




var controlOptions = {
  circleControl: {
      position: 'topleft',
      callback: map.editTools.startCircle,
      kind: 'circle',
      html: 'â¬¤',
      name: 'CircleControl'
  },
  polygonControl: {
          position: 'topleft',
          callback: map.editTools.startPolygon,
          kind: 'polygon',
          html: 'â–°',
          name: 'PolygonControl'
      },

  rectangleControl: {
          position: 'topleft',
          callback: map.editTools.startRectangle,
          kind: 'rectangle',
          html: 'â¬›',
          name: 'RectangleControl'
      },
  markerControl: {
      position: 'topleft',
      callback: map.editTools.startMarker,
      kind: 'marker',
      html: 'ðŸ–ˆ',
      name: 'MarkerControl'
  },
  polylineControl: {
          position: 'topleft',
          callback: map.editTools.startPolyline,
          kind: 'line',
          html: '\\/\\',
          name: 'PolylineControl'
      }


};
  L.EditControl = L.Control.extend({

      options: {
          position: 'topleft',
          callback: null,
          kind: '',
          html: ''
      },

      onAdd: function (map) {
          var container = L.DomUtil.create('div', 'leaflet-control leaflet-bar'),
              link = L.DomUtil.create('a', '', container);

          link.href = '#';
          link.title = 'Create a new ' + this.options.kind;
          link.innerHTML = this.options.html;
          L.DomEvent.on(link, 'click', L.DomEvent.stop)
                    .on(link, 'click', function () {
                      window.LAYER = this.options.callback.call(map.editTools);
                    }, this);

          return container;
      }

  });


  for (var opts in controlOptions) {

    var controlOpts = controlOptions[opts];

    var n = `${controlOpts.name}`;

    L[n] = L.EditControl.extend({
        options: controlOptions[opts]
    });

    map.addControl(new  L[n]());
  }};

    </script>
{% endblock header %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            {# side panel #}
            <div class="col-lg-5" id="side_panel">
                <div class="bs-component">
                    <div class="panel panel-primary">
                        <div id="messages_wrapper"></div>
                        <div class="panel-heading panel-heading-without-padding">
                            <h4>
                                <a id="hide_toogle"
                                   href="javascript:void(0)"
                                   class="btn btn-fab btn-raised glyphicon glyphicon-chevron-left toogle-button"
                                   onclick="toggle_side_panel()"></a>
                                <i class="mdi-content-add-box"></i>
                                Add Water Feature Assessment
                            </h4>
                        </div>
                        <div class="panel-body">
                            {% include "add_assessment_form.html" %}
                        </div>
                    </div>
                </div>
            </div>
            {# end side panel #}
            {# map #}
            <div class="col-lg-7" style="margin:0; padding:0;">
                <div class="col-lg-7 affix" id="map"></div>
            </div>
            {# end side panel #}
        </div>
        {# show hide toggle #}
        <a id="show_toogle"
           style="display:none;"
           href="javascript:void(0)"
           class="btn btn-fab btn-raised glyphicon glyphicon-chevron-right toogle-button"
           onclick="toggle_side_panel()"></a>



    <div class="row">
            {# side panel #}
        <div class="col-lg-12" id="">TESSSSSSSSSSSSSSST

        <div style="width: 640px; height: 420px;" id="map2"></div>
        </div></div>
    </div>
{% endblock content %}
